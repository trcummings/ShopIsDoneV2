[gd_scene load_steps=43 format=3 uid="uid://clfmotf3uelqh"]

[ext_resource type="Script" path="res://levels/Level.cs" id="1_uriqi"]
[ext_resource type="Script" path="res://environments/EnvironmentManager.cs" id="2_4ygry"]
[ext_resource type="Script" path="res://util/state_machine/StateMachine.cs" id="2_b2cin"]
[ext_resource type="Script" path="res://camera/InputXformer.cs" id="2_f8i2e"]
[ext_resource type="PackedScene" uid="uid://b2efiom6qa6ym" path="res://camera/isometric_camera.tscn" id="2_s72y3"]
[ext_resource type="PackedScene" uid="uid://df0fk08hmrihh" path="res://microgames/microgame_manager.tscn" id="3_fpukf"]
[ext_resource type="Script" path="res://levels/level_states/InitializingState.cs" id="3_v4svp"]
[ext_resource type="Script" path="res://levels/level_states/CutsceneState.cs" id="4_o6jlb"]
[ext_resource type="Script" path="res://levels/level_states/FreeMoveState.cs" id="4_x3fct"]
[ext_resource type="Script" path="res://levels/level_states/ArenaState.cs" id="5_01t8v"]
[ext_resource type="Script" path="res://levels/level_states/ExitingState.cs" id="6_50r3g"]
[ext_resource type="PackedScene" uid="uid://bsmp1sdllx60e" path="res://pausing/pause_input_handler.tscn" id="6_urg1m"]
[ext_resource type="Script" path="res://camera/CameraService.cs" id="7_5vsji"]
[ext_resource type="Script" path="res://levels/level_states/BreakRoomState.cs" id="7_jwbms"]
[ext_resource type="Script" path="res://levels/level_states/GameOverState.cs" id="7_v30x6"]
[ext_resource type="PackedScene" uid="uid://c1djrupohmfdf" path="res://audio/ui/ui_select_player.tscn" id="10_5oljb"]
[ext_resource type="Script" path="res://levels/LevelData.cs" id="10_iufdb"]
[ext_resource type="Script" path="res://camera/ScreenshakeService.cs" id="10_urica"]
[ext_resource type="PackedScene" uid="uid://swb4777ufru4" path="res://widgets/tile_indicator/tile_indicator.tscn" id="10_xe6sp"]
[ext_resource type="PackedScene" uid="uid://crqg03tk3cpdo" path="res://widgets/tile_cursor/tile_cursor.tscn" id="11_6qmyn"]
[ext_resource type="Script" path="res://camera/ScreenshakeHandler.cs" id="11_nb1sm"]
[ext_resource type="Script" path="res://util/dependency_injection/ServicesContainer.cs" id="11_v0osm"]
[ext_resource type="PackedScene" uid="uid://clxx8lr4tixdi" path="res://widgets/facing_widget/FacingWidget.tscn" id="12_vtx7j"]
[ext_resource type="Script" path="res://util/DirectionalInputHelper.cs" id="12_xguo8"]
[ext_resource type="Script" path="res://camera/PlayerCameraService.cs" id="13_pish1"]
[ext_resource type="PackedScene" uid="uid://bx37eiog04urf" path="res://widgets/finger_cursor/finger_cursor.tscn" id="14_vwmfj"]
[ext_resource type="PackedScene" uid="uid://dxjmgjjk6kswe" path="res://microgames/microgame_controller.tscn" id="15_02wap"]
[ext_resource type="PackedScene" uid="uid://b4uxifgjvks6n" path="res://widgets/move_path_widget/move_path_widget.tscn" id="15_3qirb"]
[ext_resource type="Script" path="res://levels/PlayerCharacterManager.cs" id="17_qs4bj"]
[ext_resource type="Script" path="res://levels/CutsceneService.cs" id="18_jnqhh"]
[ext_resource type="PackedScene" uid="uid://b5q8ihxc5ibv2" path="res://pausing/blur_background.tscn" id="20_qvdr3"]
[ext_resource type="Script" path="res://camera/WallXRayHelper.cs" id="21_28jhl"]
[ext_resource type="PackedScene" uid="uid://dekbcridbwhhs" path="res://pausing/level_pause_menu.tscn" id="21_u1g8v"]
[ext_resource type="PackedScene" uid="uid://vkdrv2wvhw46" path="res://levels/directional_point.tscn" id="26_7pn1o"]
[ext_resource type="PackedScene" uid="uid://ddwvyl3d8scbv" path="res://levels/level_states/game_over_ui.tscn" id="26_yq21p"]
[ext_resource type="PackedScene" uid="uid://kxhd2aa43gxp" path="res://widgets/clown_arm/clown_arm_widget.tscn" id="29_pvwuo"]
[ext_resource type="Texture2D" uid="uid://bsf743nafvrlm" path="res://textures/screenshot_example.png" id="33_7umqv"]
[ext_resource type="PackedScene" uid="uid://5tltus61wl40" path="res://lighting/silhouettes/grid_effect.tscn" id="34_4u7va"]
[ext_resource type="Material" uid="uid://dhddd5g0tswbc" path="res://lighting/silhouettes/shadow_distortion.material" id="34_52nk5"]
[ext_resource type="Material" uid="uid://dax0bf76hj7s7" path="res://lighting/silhouettes/shadow_outline.material" id="35_j1o0a"]

[sub_resource type="FastNoiseLite" id="FastNoiseLite_lbwya"]

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_ydnh5"]

[node name="Level" type="Node3D" node_paths=PackedStringArray("_LevelStateMachine")]
script = ExtResource("1_uriqi")
_LevelStateMachine = NodePath("LevelStateMachine")
metadata/_edit_lock_ = true

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
script = ExtResource("2_4ygry")

[node name="LevelStateMachine" type="Node" parent="."]
script = ExtResource("2_b2cin")

[node name="Initializing" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_PlayerCharacterManager", "_PauseInputHandler")]
script = ExtResource("3_v4svp")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")

[node name="Cutscene" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_PlayerCharacterManager", "_PauseInputHandler", "_CutsceneService")]
script = ExtResource("4_o6jlb")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")
_CutsceneService = NodePath("../../Services/CutsceneService")

[node name="FreeMove" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_CameraService", "_PlayerCameraService", "_PlayerCharacterManager", "_InputXformer", "_PauseInputHandler")]
script = ExtResource("4_x3fct")
_CameraService = NodePath("../../Services/CameraService")
_PlayerCameraService = NodePath("../../Services/PlayerCameraService")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")
_InputXformer = NodePath("../../Services/InputXformer")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")

[node name="BreakRoom" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_CameraService", "_PlayerCameraService", "_PlayerCharacterManager", "_InputXformer", "_PauseInputHandler")]
script = ExtResource("7_jwbms")
_CameraService = NodePath("../../Services/CameraService")
_PlayerCameraService = NodePath("../../Services/PlayerCameraService")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")
_InputXformer = NodePath("../../Services/InputXformer")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")

[node name="Arena" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_PlayerCharacterManager")]
script = ExtResource("5_01t8v")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")

[node name="Exiting" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_PlayerCharacterManager", "_PauseInputHandler")]
script = ExtResource("6_50r3g")
_PlayerCharacterManager = NodePath("../../World/PlayerCharacterManager")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")

[node name="GameOver" type="Node" parent="LevelStateMachine" node_paths=PackedStringArray("_PauseInputHandler", "_GameOverUI")]
script = ExtResource("7_v30x6")
_PauseInputHandler = NodePath("../../Services/PauseInputHandler")
_GameOverUI = NodePath("../../UILayer/GameOverUI")

[node name="Services" type="Node" parent="."]
unique_name_in_owner = true
script = ExtResource("11_v0osm")
_ExtraServices = [NodePath("../World/PlayerCharacterManager"), NodePath("../World/Widgets/FingerCursor"), NodePath("../World/Widgets/TileIndicator"), NodePath("../World/Widgets/MovePathWidget"), NodePath("../World/Widgets/FacingWidget"), NodePath("../World/Widgets/TileCursor"), NodePath("../World/Widgets/ClownArmWidget")]

[node name="LevelData" type="Node" parent="Services"]
script = ExtResource("10_iufdb")

[node name="CameraService" type="Node" parent="Services" node_paths=PackedStringArray("_IsometricCamera")]
script = ExtResource("7_5vsji")
_IsometricCamera = NodePath("../../World/IsometricCamera")

[node name="InputXformer" type="Node" parent="Services" node_paths=PackedStringArray("_Camera")]
script = ExtResource("2_f8i2e")
_Camera = NodePath("../../World/IsometricCamera")

[node name="PauseInputHandler" parent="Services" instance=ExtResource("6_urg1m")]
IsActive = true

[node name="ScreenshakeService" type="Node" parent="Services" node_paths=PackedStringArray("_IsometricCamera", "_Screenshake")]
script = ExtResource("10_urica")
_IsometricCamera = NodePath("../../World/IsometricCamera")
_Screenshake = NodePath("ScreenshakeHandler")

[node name="ScreenshakeHandler" type="Node" parent="Services/ScreenshakeService"]
script = ExtResource("11_nb1sm")
Noise = SubResource("FastNoiseLite_lbwya")

[node name="DirectionalInputHelper" type="Node" parent="Services" node_paths=PackedStringArray("_IsometricCamera")]
script = ExtResource("12_xguo8")
_IsometricCamera = NodePath("../../World/IsometricCamera")

[node name="PlayerCameraService" type="Node" parent="Services" node_paths=PackedStringArray("_Camera")]
script = ExtResource("13_pish1")
_Camera = NodePath("../../World/IsometricCamera")

[node name="UISelectPlayer" parent="Services/PlayerCameraService" instance=ExtResource("10_5oljb")]

[node name="MicrogameController" parent="Services" node_paths=PackedStringArray("_MicrogameManager") instance=ExtResource("15_02wap")]
_MicrogameManager = NodePath("../../UILayer/MicrogameUIContainer/MicrogameManager")

[node name="CutsceneService" type="Node" parent="Services" node_paths=PackedStringArray("_LevelStateMachine")]
script = ExtResource("18_jnqhh")
_LevelStateMachine = NodePath("../../LevelStateMachine")

[node name="WallXRayHelper" type="Node" parent="Services" node_paths=PackedStringArray("_CharacterManager", "_Camera")]
script = ExtResource("21_28jhl")
_CharacterManager = NodePath("../../World/PlayerCharacterManager")
_Camera = NodePath("../../World/IsometricCamera/Camera")

[node name="Audio" type="Node" parent="."]

[node name="UISelectPlayer" parent="Audio" instance=ExtResource("10_5oljb")]

[node name="World" type="Node3D" parent="."]
process_mode = 1

[node name="Widgets" type="Node3D" parent="World"]

[node name="TileIndicator" parent="World/Widgets" instance=ExtResource("10_xe6sp")]

[node name="TileCursor" parent="World/Widgets" instance=ExtResource("11_6qmyn")]
visible = false

[node name="FacingWidget" parent="World/Widgets" instance=ExtResource("12_vtx7j")]
visible = false

[node name="FingerCursor" parent="World/Widgets" instance=ExtResource("14_vwmfj")]
visible = false

[node name="MovePathWidget" parent="World/Widgets" instance=ExtResource("15_3qirb")]
visible = false

[node name="ClownArmWidget" parent="World/Widgets" instance=ExtResource("29_pvwuo")]
visible = false

[node name="IsometricCamera" parent="World" instance=ExtResource("2_s72y3")]

[node name="Camera" parent="World/IsometricCamera" index="0"]
current = true

[node name="CharacterIlluminator" type="DirectionalLight3D" parent="World/IsometricCamera/Camera" index="0"]
layers = 256
light_energy = 0.2
light_cull_mask = 4293918976

[node name="GridRemoteTransform" type="RemoteTransform3D" parent="World/IsometricCamera/Camera" index="1"]
remote_path = NodePath("../../../GridSubViewport/Pivot/Camera")

[node name="LightsRemoteTransform" type="RemoteTransform3D" parent="World/IsometricCamera/Camera" index="2"]
remote_path = NodePath("../../../LightSubViewport/Pivot/Camera")

[node name="WidgetsRemoteTransform" type="RemoteTransform3D" parent="World/IsometricCamera/Camera" index="3"]
remote_path = NodePath("../../../WidgetsSubViewport/Pivot/Camera")

[node name="PlayerCharacterManager" type="Node3D" parent="World" node_paths=PackedStringArray("_DefaultSpawnPoint")]
script = ExtResource("17_qs4bj")
_DefaultSpawnPoint = NodePath("../DefaultSpawnPoint")
metadata/_edit_lock_ = true

[node name="NavigationRegion3D" type="NavigationRegion3D" parent="World"]
metadata/_edit_lock_ = true

[node name="Environment" type="Node3D" parent="World/NavigationRegion3D"]
metadata/_edit_lock_ = true

[node name="DefaultSpawnPoint" parent="World" instance=ExtResource("26_7pn1o")]

[node name="GridSubViewport" type="SubViewport" parent="World"]
transparent_bg = true
size = Vector2i(1920, 1080)

[node name="Pivot" type="Node3D" parent="World/GridSubViewport"]

[node name="Camera" type="Camera3D" parent="World/GridSubViewport/Pivot" groups=["camera_clone"]]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 50)
cull_mask = 2
projection = 1
current = true
size = 15.0

[node name="LightSubViewport" type="SubViewport" parent="World"]
transparent_bg = true
size = Vector2i(1920, 1080)

[node name="Pivot" type="Node3D" parent="World/LightSubViewport"]

[node name="Camera" type="Camera3D" parent="World/LightSubViewport/Pivot" groups=["camera_clone"]]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 50)
cull_mask = 8
projection = 1
current = true
size = 15.0

[node name="WidgetsSubViewport" type="SubViewport" parent="World"]
transparent_bg = true
size = Vector2i(1920, 1080)

[node name="Pivot" type="Node3D" parent="World/WidgetsSubViewport"]

[node name="Camera" type="Camera3D" parent="World/WidgetsSubViewport/Pivot" groups=["camera_clone"]]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 50)
cull_mask = 4
projection = 1
current = true
size = 15.0

[node name="PostProcessing" type="CanvasLayer" parent="."]
follow_viewport_enabled = true

[node name="Effects" type="Control" parent="PostProcessing"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
metadata/_edit_use_anchors_ = true

[node name="EffectsTest" type="TextureRect" parent="PostProcessing/Effects"]
visible = false
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource("33_7umqv")

[node name="BackBufferCopy" type="BackBufferCopy" parent="PostProcessing/Effects"]
copy_mode = 2

[node name="Distortion" type="SubViewportContainer" parent="PostProcessing/Effects"]
material = ExtResource("34_52nk5")
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
stretch = true

[node name="SubViewport2" type="SubViewport" parent="PostProcessing/Effects/Distortion"]
transparent_bg = true
handle_input_locally = false
size = Vector2i(1920, 1080)
render_target_update_mode = 4

[node name="ShadowOutline" type="SubViewportContainer" parent="PostProcessing/Effects/Distortion/SubViewport2"]
material = ExtResource("35_j1o0a")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="SubViewport" type="SubViewport" parent="PostProcessing/Effects/Distortion/SubViewport2/ShadowOutline"]
transparent_bg = true
handle_input_locally = false
size = Vector2i(1920, 1080)
render_target_update_mode = 4

[node name="GridEffect" parent="PostProcessing/Effects/Distortion/SubViewport2/ShadowOutline/SubViewport" node_paths=PackedStringArray("_TileCursor", "_Camera", "_GridSubViewport", "_LightSubViewport", "_WidgetsViewport") instance=ExtResource("34_4u7va")]
modulate = Color(1, 1, 1, 0)
_TileCursor = NodePath("../../../../../../../World/Widgets/TileCursor")
_Camera = NodePath("../../../../../../../World/IsometricCamera/Camera")
_GridSubViewport = NodePath("../../../../../../../World/GridSubViewport")
_LightSubViewport = NodePath("../../../../../../../World/LightSubViewport")
_WidgetsViewport = NodePath("../../../../../../../World/WidgetsSubViewport")

[node name="UILayer" type="CanvasLayer" parent="."]
process_mode = 1
layer = 64
follow_viewport_enabled = true

[node name="MicrogameUIContainer" type="PanelContainer" parent="UILayer"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
theme_override_styles/panel = SubResource("StyleBoxEmpty_ydnh5")
metadata/_edit_lock_ = true

[node name="MicrogameManager" parent="UILayer/MicrogameUIContainer" node_paths=PackedStringArray("_FrameContainer") instance=ExtResource("3_fpukf")]
layout_mode = 2
_FrameContainer = NodePath("..")

[node name="BlurBackground" parent="UILayer" instance=ExtResource("20_qvdr3")]
grow_horizontal = 2
grow_vertical = 2
metadata/_edit_lock_ = true

[node name="GameOverUI" parent="UILayer" instance=ExtResource("26_yq21p")]
visible = false

[node name="LevelPauseMenu" parent="." node_paths=PackedStringArray("_BlurBackground") instance=ExtResource("21_u1g8v")]
layer = 96
visible = false
follow_viewport_enabled = true
_BlurBackground = NodePath("../UILayer/BlurBackground")

[connection signal="GamePaused" from="Services/PauseInputHandler" to="LevelPauseMenu" method="Activate"]
[connection signal="GameUnpaused" from="Services/PauseInputHandler" to="LevelPauseMenu" method="Deactivate"]
[connection signal="CameraRotated" from="Services/PlayerCameraService" to="Services/PlayerCameraService/UISelectPlayer" method="play"]
[connection signal="UnpauseRequested" from="LevelPauseMenu" to="Services/PauseInputHandler" method="RequestUnpause"]

[editable path="World/IsometricCamera"]
